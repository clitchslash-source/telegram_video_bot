# Telegram Video Generator Bot - Инструкция по развертыванию

## Обзор

Это полнофункциональный Telegram бот для генерации видео через KIE.AI с системой монетизации на основе токенов и интеграцией платежей через Яндекс.Касса.

## Архитектура

```
Telegram User → Telegram Bot → Backend Server → KIE.AI (Video Generation)
                                            ↓
                                    Yandex.Kassa (Payments)
                                            ↓
                                    Notion (User Analytics)
```

## Требуемые учетные данные

Все необходимые API ключи уже сохранены в защищенном хранилище:

- **TELEGRAM_BOT_TOKEN**: [Stored in Railway Variables]
- **KIE_AI_API_KEY**: [Stored in Railway Variables]
- **YANDEX_KASSA_SHOP_ID**: [Stored in Railway Variables]
- **YANDEX_KASSA_SECRET_KEY**: [Stored in Railway Variables]
- **NOTION_API_KEY**: [Stored in Railway Variables]
- **NOTION_DATABASE_ID**: [Stored in Railway Variables]

## Структура базы данных

### Таблицы

1. **telegram_users** - Информация о пользователях Telegram
   - telegramId, username, firstName, lastName
   - tokenBalance, totalTokensPurchased, totalTokensSpent
   - totalGenerations, isActive, timestamps

2. **token_transactions** - История всех операций с токенами
   - type: purchase, generation, removal, refund, bonus
   - amount, balanceBefore, balanceAfter
   - description, relatedTransactionId

3. **video_generations** - История генераций видео
   - inputType: text, image, voice
   - duration: 10, 15 сек
   - quality, prompt, inputFileUrl, outputVideoUrl
   - tokensCost, watermarkRemovalApplied, status

4. **payment_transactions** - История платежей Яндекс.Касса
   - paymentId, amount, tokens
   - status: pending, succeeded, failed, cancelled
   - paymentMethod, notionSynced

5. **notion_sync_status** - Отслеживание синхронизации с Notion
   - entityType, entityId, telegramId
   - notionPageId, synced, syncedAt

## Система цен

| Услуга | Стоимость |
|--------|-----------|
| Видео 10 сек | 20 токенов |
| Видео 15 сек | 25 токенов |
| Удаление водяного знака | 10 токенов |
| Бесплатные токены при регистрации | 60 токенов |

## Пакеты покупки токенов

| Сумма | Токены |
|-------|--------|
| 500 руб | 500 токенов |
| 1000 руб | 1000 токенов |
| 2000 руб | 2000 токенов |
| 4000 руб | 4000 токенов |

## Команды бота

- `/start` - Начало работы (выдает 60 бесплатных токенов при первом входе)
- `/balance` - Проверить текущий баланс токенов
- `/buy` - Купить токены (выбор пакета)
- `/help` - Справка по командам

## Функции генерации видео

### Входные данные

1. **Текст (промпт)** - Описание видео на русском или английском
2. **Изображение** - Фото, на основе которого генерируется видео
3. **Голос** - Голосовое сообщение, которое преобразуется в видео

### Параметры

- **Длительность**: 10 или 15 секунд
- **Качество**: Низкое, Стандартное, Высокое
- **Удаление водяного знака**: Опционально (10 токенов)

## Интеграция с Notion

Таблица в Notion автоматически обновляется в реальном времени с информацией о:

- Текущем балансе каждого пользователя
- Количестве купленных токенов
- Количестве потраченных токенов
- Истории генераций видео
- Истории платежей

## Процесс платежа

1. Пользователь нажимает кнопку "Купить токены"
2. Выбирает пакет (500, 1000, 2000 или 4000 руб)
3. Получает ссылку на оплату через Яндекс.Касса
4. После успешной оплаты токены автоматически зачисляются
5. Notion таблица обновляется

## Webhook endpoints

### Telegram Webhook
- **POST** `/api/telegram/webhook` - Получение обновлений от Telegram
- **POST** `/api/telegram/payment-webhook` - Подтверждение платежей от Яндекс.Касса

## Развертывание

### 1. Локальное тестирование

```bash
# Установка зависимостей
pnpm install

# Запуск dev сервера
pnpm dev
```

### 2. Настройка Telegram webhook

После развертывания на production сервер, установите webhook:

```bash
curl -X POST https://api.telegram.org/bot{TOKEN}/setWebhook \
  -H "Content-Type: application/json" \
  -d '{"url": "https://your-domain.com/api/telegram/webhook"}'
```

### 3. Настройка Яндекс.Касса webhook

В личном кабинете Яндекс.Касса установите webhook URL:
```
https://your-domain.com/api/telegram/payment-webhook
```

## Мониторинг

### Логирование

Все операции логируются в консоль:
- Создание пользователей
- Генерация видео
- Платежи
- Ошибки API

### Метрики в Notion

Таблица в Notion служит как основная аналитика:
- Количество активных пользователей
- Общий объем купленных токенов
- Популярные типы генерации (текст/фото/голос)
- Среднее время генерации видео

## Обработка ошибок

### Недостаточно токенов
Бот информирует пользователя о необходимом количестве токенов и предлагает купить.

### Ошибка генерации видео
Если KIE.AI вернул ошибку, пользователю возвращаются потраченные токены.

### Ошибка платежа
Если платеж не прошел, токены не зачисляются и пользователь может повторить попытку.

## Безопасность

- Все API ключи хранятся в защищенных переменных окружения
- Webhook подписи проверяются перед обработкой
- Все операции с токенами логируются
- Данные пользователей синхронизируются с Notion для резервного копирования

## Техническая поддержка

При возникновении проблем:

1. Проверьте логи сервера
2. Убедитесь, что все API ключи корректны
3. Проверьте статус KIE.AI и Яндекс.Касса API
4. Проверьте подключение к базе данных

## Будущие улучшения

- [ ] Кэширование результатов генерации
- [ ] История загруженных файлов
- [ ] Пакеты подписки (месячные, годовые)
- [ ] Реферальная программа
- [ ] Поддержка нескольких языков
- [ ] Интеграция с другими платежными системами
